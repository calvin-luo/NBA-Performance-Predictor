{% extends "base.html" %}

{# ----------------------------------------- #}
{#  Player Profile Page – Stat Lemon v2.0   #}
{#  Implements Tasks 8, 9 & 10 of overhaul  #}
{# ----------------------------------------- #}

{% block title %}{{ player_name }} – Player Profile | Stat Lemon{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ player_name }}</li>
      </ol>
    </nav>
  </div>
</div>

<!-- =======================
     Player Header          
     ======================= -->
<div class="row align-items-center mb-4">
  <div class="col-md-2 text-center mb-3 mb-md-0">
    <!-- Dynamic profile picture (NBA head‑shot → initials fallback) -->
    <div id="player-profile-picture"></div>
  </div>
  <div class="col-md-10">
    <h1 class="display-5 fw-bold mb-1">{{ player_name }}</h1>
    <p class="text-muted mb-0" id="player-team-position">Loading team &amp; position…</p>
  </div>
</div>

<!-- =======================
     Tabs Navigation        
     ======================= -->
<ul class="nav nav-tabs mb-4" id="playerTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="fantasy-tab" data-bs-toggle="tab" data-bs-target="#fantasy" type="button" role="tab" aria-controls="fantasy" aria-selected="false">Fantasy Categories</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="gamelog-tab" data-bs-toggle="tab" data-bs-target="#gamelog" type="button" role="tab" aria-controls="gamelog" aria-selected="false">Recent Games</button>
  </li>
</ul>

<div class="tab-content" id="playerTabsContent">
  <!-- ========= Overview ========= -->
  <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
    <div class="row g-4" id="overview-cards">
      <!-- Metric cards injected via JS (minutes, PTS, REB, AST, STL, BLK, 3PM, FG) -->
    </div>

    <!-- Radar chart comparing core counting stats per‑game vs league percentiles -->
    <div class="card mt-4 shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span>Volume &amp; Defensive Strengths</span>
        <div id="overview-chart-loader" class="spinner-border spinner-border-sm" role="status"></div>
      </div>
      <div class="card-body">
        <canvas id="volumeRadarChart" height="320"></canvas>
      </div>
    </div>
  </div>

  <!-- ======== Fantasy Categories ======== -->
  <div class="tab-pane fade" id="fantasy" role="tabpanel" aria-labelledby="fantasy-tab">
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span>Category Radar (9‑Cat)</span>
            <div id="fantasy-radar-loader" class="spinner-border spinner-border-sm" role="status"></div>
          </div>
          <div class="card-body">
            <canvas id="fantasyRadarChart" height="320"></canvas>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-primary text-white">Percentile Rankings</div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0" id="fantasyPercentileTable">
                <thead class="table-light">
                  <tr>
                    <th>Category</th>
                    <th class="text-end">Percentile</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Rows injected via JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======== Game Log ======== -->
  <div class="tab-pane fade" id="gamelog" role="tabpanel" aria-labelledby="gamelog-tab">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span>Last 30 Games</span>
        <div id="gamelog-loader" class="spinner-border spinner-border-sm" role="status"></div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-striped mb-0" id="gameLogTable">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>OPP</th>
                <th>MIN</th>
                <th>PTS</th>
                <th>REB</th>
                <th>AST</th>
                <th>STL</th>
                <th>BLK</th>
                <th>3PM</th>
                <th>FG (M‑A)</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows injected via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // -------------------------------------------
    //  Client‑side Controller for Player Profile
    // -------------------------------------------
    (function() {
      const playerName = "{{ player_name|escapejs }}";

      // Inject dynamic profile picture
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('player-profile-picture').innerHTML = generatePlayerProfilePicture(playerName, 140);
      });

    // ----- PREDICTIONS (keep for the radar) -----
    fetchPlayerPredictions(playerName)
    .then(data => {
        buildVolumeRadar(data);      // radar needs forecast
    })
    .catch(() => showAlert('Unable to load predictions.', 'danger'))
    .finally(() => document.getElementById('overview-chart-loader').classList.add('d-none'));

    // ----- STATS (drives the cards + game log) -----
    fetchPlayerStats(playerName)
    .then(data => {
        updatePlayerOverview(data.stats);   // <-- NEW LINE
        populateGameLog(data.stats);
    })
    .catch(() => showAlert('Game log unavailable.', 'warning'))
    .finally(() => document.getElementById('gamelog-loader').classList.add('d-none'));


      // -------------- Helpers ------------------
      function updateOverviewCards(prediction) {
        const metrics = [
          { key: 'MINUTES_PLAYED', label: 'Minutes', icon: 'clock' },
          { key: 'PTS', label: 'Points', icon: 'basketball-ball' },
          { key: 'REB', label: 'Rebounds', icon: 'table' },
          { key: 'AST', label: 'Assists', icon: 'handshake' },
          { key: 'STL', label: 'Steals', icon: 'hand-scissors' },
          { key: 'BLK', label: 'Blocks', icon: 'ban' },
          { key: 'FG3M', label: '3‑Pointers', icon: 'bullseye' },
          { key: 'FGM', label: 'FG Made/Att', icon: 'percentage', twin: 'FGA' }
        ];
        const row = document.getElementById('overview-cards');
        metrics.forEach(m => {
          const val = getNested(prediction, m.key);
          const att = m.twin ? getNested(prediction, m.twin) : null;
          row.insertAdjacentHTML('beforeend', `
            <div class="col-6 col-md-3">
              <div class="card text-center shadow-sm h-100">
                <div class="card-body py-3">
                  <i class="fas fa-${m.icon} fa-lg text-primary mb-2"></i>
                  <h5 class="card-title mb-0">${m.label}</h5>
                  <p class="display-6 fw-bold mb-0">
                    ${val !== null ? val.toFixed(1) : '--'}${att !== null ? `/<span class="text-muted">${att.toFixed(1)}</span>` : ''}
                  </p>
                </div>
              </div>
            </div>`);
        });
      }

      function buildVolumeRadar(prediction) {
        const labels = ['PTS', 'REB', 'AST', 'STL', 'BLK', '3PM'];
        const data = labels.map(l => getNested(prediction, l));
        createRadarChart('volumeRadarChart', labels, [{
          label: playerName,
          data: data,
          backgroundColor: CHART_COLORS.primaryLight,
          borderColor: CHART_COLORS.primary,
          pointBackgroundColor: CHART_COLORS.primary
        }]);
      }

      function buildFantasyRadar(data) {
        const labels = data.categories;
        createRadarChart('fantasyRadarChart', labels, [{
          label: 'Percentile',
          data: data.percentiles,
          backgroundColor: CHART_COLORS.successLight,
          borderColor: CHART_COLORS.success,
          pointBackgroundColor: CHART_COLORS.success
        }]);
      }

      function populateFantasyPercentiles(data) {
        const tbody = document.querySelector('#fantasyPercentileTable tbody');
        data.categories.forEach((cat, idx) => {
          const pct = data.percentiles[idx];
          tbody.insertAdjacentHTML('beforeend', `<tr><td>${cat}</td><td class="text-end">${pct}%</td></tr>`);
        });
      }

      function populateGameLog(rows) {
        const tbody = document.querySelector('#gameLogTable tbody');
        rows.forEach(g => {
          tbody.insertAdjacentHTML('beforeend', `<tr>
            <td>${g.GAME_DATE}</td>
            <td>${g.OPP}</td>
            <td>${g.MINUTES_PLAYED.toFixed(1)}</td>
            <td>${g.PTS}</td>
            <td>${g.REB}</td>
            <td>${g.AST}</td>
            <td>${g.STL}</td>
            <td>${g.BLK}</td>
            <td>${g.FG3M}</td>
            <td>${g.FGM}‑${g.FGA}</td>
          </tr>`);
        });
      }

      function getNested(obj, key) {
        return obj && obj.player_predictions && obj.player_predictions[playerName] && obj.player_predictions[playerName][key] ? obj.player_predictions[playerName][key].forecast : null;
      }
    })();
  </script>
{% endblock %}
