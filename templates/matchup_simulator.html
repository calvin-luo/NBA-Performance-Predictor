{% extends "base.html" %}

{% block title %}NBA Matchup Simulator - Stat Lemon{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Matchup Simulator</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">NBA Matchup Simulator</h4>
            </div>
            <div class="card-body">
                <p>Select two NBA teams and simulate the outcome of their matchup using advanced statistical models.</p>
                
                <form id="matchup-form" class="mt-4">
                    <div class="row align-items-center">
                        <div class="col-md-5">
                            <label for="away-team" class="form-label">Away Team</label>
                            <select class="form-select" id="away-team" name="away_team" required>
                                <option value="">Select Away Team</option>
                                <!-- Will be populated with JavaScript -->
                            </select>
                        </div>
                        
                        <div class="col-md-2 d-flex justify-content-center my-3 my-md-0">
                            <div class="vs-badge bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <span class="fw-bold fs-5">VS</span>
                            </div>
                        </div>
                        
                        <div class="col-md-5">
                            <label for="home-team" class="form-label">Home Team</label>
                            <select class="form-select" id="home-team" name="home_team" required>
                                <option value="">Select Home Team</option>
                                <!-- Will be populated with JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="use-current-lineups" checked>
                                <label class="form-check-label" for="use-current-lineups">
                                    Use current lineups
                                </label>
                                <small class="form-text text-muted d-block">Uncheck to customize lineups for both teams</small>
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <button type="button" id="simulate-btn" class="btn btn-primary px-4">
                                <i class="fas fa-chart-line me-2"></i> Simulate Matchup
                            </button>
                            <button type="button" id="reset-btn" class="btn btn-outline-secondary px-4 ms-2">
                                <i class="fas fa-redo me-2"></i> Reset
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Team Lineups (Initially Hidden) -->
<div id="lineups-section" class="row mb-4" style="display: none;">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Team Lineups</h5>
                <button class="btn btn-sm btn-outline-primary" id="edit-lineups-btn">
                    <i class="fas fa-edit me-1"></i> Edit Lineups
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 id="away-team-name" class="text-center mb-3">Away Team</h6>
                        <ul class="list-group" id="away-lineup">
                            <li class="list-group-item text-center py-3">
                                Select away team to see lineup
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 id="home-team-name" class="text-center mb-3">Home Team</h6>
                        <ul class="list-group" id="home-lineup">
                            <li class="list-group-item text-center py-3">
                                Select home team to see lineup
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simulation Results (Initially Hidden) -->
<div id="results-section" class="row mb-4" style="display: none;">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Simulation Results</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center mb-4">
                    <div class="col-md-5 text-center">
                        <div class="team-logo mb-2">
                            <img src="" id="away-team-logo" width="80" height="80" alt="Away Team">
                        </div>
                        <h5 id="away-team-result">Away Team</h5>
                        <div class="predicted-score">
                            <span class="display-5 fw-bold" id="away-predicted-score">0.0</span>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex flex-column align-items-center justify-content-center my-3 my-md-0">
                        <div class="fs-5 mb-2">Predicted Score</div>
                        <div class="badge bg-dark p-2">
                            <span id="away-win-probability">50</span>% - <span id="home-win-probability">50</span>%
                        </div>
                    </div>
                    <div class="col-md-5 text-center">
                        <div class="team-logo mb-2">
                            <img src="" id="home-team-logo" width="80" height="80" alt="Home Team">
                        </div>
                        <h5 id="home-team-result">Home Team</h5>
                        <div class="predicted-score">
                            <span class="display-5 fw-bold" id="home-predicted-score">0.0</span>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Team Comparison</h5>
                        <canvas id="teamComparisonChart" width="400" height="300"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h5>Win Probability Distribution</h5>
                        <canvas id="winProbabilityChart" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5>Key Factors</h5>
                        <ul class="list-group" id="key-factors">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Home Court Advantage</strong>
                                    <p class="mb-0 text-muted small">Teams typically perform better at home</p>
                                </div>
                                <span class="badge bg-primary rounded-pill">+3.2 points</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Recent Form</strong>
                                    <p class="mb-0 text-muted small">Based on last 10 games performance</p>
                                </div>
                                <span id="recent-form-badge" class="badge bg-success rounded-pill">+2.5 points for Home</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Shooting Efficiency</strong>
                                    <p class="mb-0 text-muted small">True Shooting % comparison</p>
                                </div>
                                <span id="shooting-badge" class="badge bg-danger rounded-pill">+1.8 points for Away</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Matchup History</strong>
                                    <p class="mb-0 text-muted small">Based on previous meetings this season</p>
                                </div>
                                <span id="history-badge" class="badge bg-secondary rounded-pill">Neutral</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <h5>Key Player Matchups</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Position</th>
                                <th>Away Player</th>
                                <th>Stats</th>
                                <th>Advantage</th>
                                <th>Stats</th>
                                <th>Home Player</th>
                            </tr>
                        </thead>
                        <tbody id="matchups-table">
                            <tr>
                                <td colspan="6" class="text-center py-3">
                                    Select teams to see key matchups
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- What-If Analysis Section (Initially Hidden) -->
<div id="whatif-section" class="row mb-5" style="display: none;">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">What-If Analysis</h5>
            </div>
            <div class="card-body">
                <p>Adjust parameters to see how they affect the outcome.</p>
                
                <div class="row mt-3">
                    <div class="col-md-4 mb-3">
                        <label for="home-performance-slider" class="form-label">Home Team Performance</label>
                        <input type="range" class="form-range" min="-20" max="20" value="0" id="home-performance-slider">
                        <div class="d-flex justify-content-between">
                            <span class="small text-muted">Underperform</span>
                            <span class="small text-muted">Average</span>
                            <span class="small text-muted">Overperform</span>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="away-performance-slider" class="form-label">Away Team Performance</label>
                        <input type="range" class="form-range" min="-20" max="20" value="0" id="away-performance-slider">
                        <div class="d-flex justify-content-between">
                            <span class="small text-muted">Underperform</span>
                            <span class="small text-muted">Average</span>
                            <span class="small text-muted">Overperform</span>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="home-court-slider" class="form-label">Home Court Advantage</label>
                        <input type="range" class="form-range" min="0" max="10" value="3" id="home-court-slider">
                        <div class="d-flex justify-content-between">
                            <span class="small text-muted">None</span>
                            <span class="small text-muted">Average</span>
                            <span class="small text-muted">Strong</span>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-2">
                    <div class="col-md-12 text-center">
                        <button type="button" id="update-simulation-btn" class="btn btn-primary px-4">
                            <i class="fas fa-sync me-2"></i> Update Simulation
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Lineups Modal -->
<div class="modal fade" id="editLineupsModal" tabindex="-1" aria-labelledby="editLineupsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editLineupsModalLabel">Edit Team Lineups</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 id="edit-away-team-name" class="mb-3">Away Team</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Position</th>
                                        <th>Current Player</th>
                                        <th>Replacement</th>
                                    </tr>
                                </thead>
                                <tbody id="edit-away-lineup">
                                    <tr>
                                        <td>PG</td>
                                        <td id="away-pg">Player 1</td>
                                        <td>
                                            <select class="form-select form-select-sm away-player-select" data-position="PG">
                                                <option value="">Select Player</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>SG</td>
                                        <td id="away-sg">Player 2</td>
                                        <td>
                                            <select class="form-select form-select-sm away-player-select" data-position="SG">
                                                <option value="">Select Player</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>SF</td>
                                        <td id="away-sf">Player 3</td>
                                        <td>
                                            <select class="form-select form-select-sm away-player-select" data-position="SF">
                                                <option value="">Select Player</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>PF</td>
                                        <td id="away-pf">Player 4</td>
                                        <td>
                                            <select class="form-select form-select-sm away-player-select" data-position="PF">
                                                <option value="">Select Player</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>C</td>
                                        <td id="away-c">Player 5</td>
                                        <td>
                                            <select class="form-select form-select-sm away-player-select" data-position="C">
                                                <option value="">Select Player</option>
                                            </select>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 id="edit-home-team-name" class="mb-3">Home Team</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Position</th>
                                        <th>Current Player</th>
                                        <th>Replacement</th>
                                    </tr>
                                </thead>
                                <tbody id="edit-home-lineup">
                                    <tr>
                                        <td>PG</td>
                                        <td id="home-pg">Player 1</td>
                                        <td>
                                            <select class="form-select form-select-sm home-player-select" data-position="PG">
                                                <option value="">Select Player</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>SG</td>
                                        <td id="home-sg">Player 2</td>
                                        <td>
                                            <select class="form-select form-select-sm home-player-select" data-position="SG">
                                                <option value="">Select Player</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>SF</td>
                                        <td id="home-sf">Player 3</td>
                                        <td>
                                            <select class="form-select form-select-sm home-player-select" data-position="SF">
                                                <option value="">Select Player</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>PF</td>
                                        <td id="home-pf">Player 4</td>
                                        <td>
                                            <select class="form-select form-select-sm home-player-select" data-position="PF">
                                                <option value="">Select Player</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>C</td>
                                        <td id="home-c">Player 5</td>
                                        <td>
                                            <select class="form-select form-select-sm home-player-select" data-position="C">
                                                <option value="">Select Player</option>
                                            </select>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-lineups-btn">Apply Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // NBA Teams list
    const nbaTeams = [
        "Atlanta Hawks", "Boston Celtics", "Brooklyn Nets", "Charlotte Hornets",
        "Chicago Bulls", "Cleveland Cavaliers", "Dallas Mavericks", "Denver Nuggets",
        "Detroit Pistons", "Golden State Warriors", "Houston Rockets", "Indiana Pacers",
        "Los Angeles Clippers", "Los Angeles Lakers", "Memphis Grizzlies", "Miami Heat",
        "Milwaukee Bucks", "Minnesota Timberwolves", "New Orleans Pelicans", "New York Knicks",
        "Oklahoma City Thunder", "Orlando Magic", "Philadelphia 76ers", "Phoenix Suns",
        "Portland Trail Blazers", "Sacramento Kings", "San Antonio Spurs", "Toronto Raptors",
        "Utah Jazz", "Washington Wizards"
    ];
    
    // Sample team rosters (would come from API in production)
    const teamRosters = {
        "Boston Celtics": [
            { name: "Jrue Holiday", position: "PG", rating: 85 },
            { name: "Derrick White", position: "SG", rating: 82 },
            { name: "Jaylen Brown", position: "SF", rating: 89 },
            { name: "Jayson Tatum", position: "PF", rating: 93 },
            { name: "Kristaps Porzingis", position: "C", rating: 87 },
            { name: "Al Horford", position: "PF", rating: 80 },
            { name: "Sam Hauser", position: "SF", rating: 75 },
            { name: "Payton Pritchard", position: "PG", rating: 76 }
        ],
        "Los Angeles Lakers": [
            { name: "D'Angelo Russell", position: "PG", rating: 82 },
            { name: "Austin Reaves", position: "SG", rating: 80 },
            { name: "LeBron James", position: "SF", rating: 95 },
            { name: "Rui Hachimura", position: "PF", rating: 79 },
            { name: "Anthony Davis", position: "C", rating: 93 },
            { name: "Taurean Prince", position: "SF", rating: 75 },
            { name: "Gabe Vincent", position: "PG", rating: 76 },
            { name: "Jarred Vanderbilt", position: "PF", rating: 78 }
        ],
        "Milwaukee Bucks": [
            { name: "Damian Lillard", position: "PG", rating: 90 },
            { name: "Malik Beasley", position: "SG", rating: 77 },
            { name: "Khris Middleton", position: "SF", rating: 85 },
            { name: "Giannis Antetokounmpo", position: "PF", rating: 96 },
            { name: "Brook Lopez", position: "C", rating: 84 },
            { name: "Bobby Portis", position: "PF", rating: 80 },
            { name: "Pat Connaughton", position: "SG", rating: 76 },
            { name: "MarJon Beauchamp", position: "SF", rating: 74 }
        ]
    };
    
    // Charts
    let teamComparisonChart;
    let winProbabilityChart;
    
    // Selected teams
    let selectedHomeTeam = '';
    let selectedAwayTeam = '';
    
    $(document).ready(function() {
        // Populate team dropdowns
        populateTeamDropdowns();
        
        // Check for URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('home') && urlParams.has('away')) {
            const homeTeam = urlParams.get('home');
            const awayTeam = urlParams.get('away');
            
            // Set dropdown values
            if (nbaTeams.includes(homeTeam)) {
                $('#home-team').val(homeTeam);
                selectedHomeTeam = homeTeam;
            }
            
            if (nbaTeams.includes(awayTeam)) {
                $('#away-team').val(awayTeam);
                selectedAwayTeam = awayTeam;
            }
            
            // Show lineups if both teams are selected
            if (selectedHomeTeam && selectedAwayTeam) {
                updateTeamLineups();
                $('#lineups-section').show();
            }
        }
        
        // Handle team selection changes
        $('#home-team, #away-team').change(function() {
            const homeTeam = $('#home-team').val();
            const awayTeam = $('#away-team').val();
            
            selectedHomeTeam = homeTeam;
            selectedAwayTeam = awayTeam;
            
            // Show lineups if both teams are selected
            if (homeTeam && awayTeam) {
                updateTeamLineups();
                $('#lineups-section').show();
            } else {
                $('#lineups-section').hide();
            }
            
            // Hide results when teams change
            $('#results-section').hide();
            $('#whatif-section').hide();
        });
        
        // Handle simulate button click
        $('#simulate-btn').click(function() {
            if (selectedHomeTeam && selectedAwayTeam) {
                simulateMatchup();
            } else {
                alert('Please select both home and away teams first.');
            }
        });
        
        // Handle reset button click
        $('#reset-btn').click(function() {
            // Reset form
            $('#matchup-form')[0].reset();
            
            // Reset selected teams
            selectedHomeTeam = '';
            selectedAwayTeam = '';
            
            // Hide sections
            $('#lineups-section').hide();
            $('#results-section').hide();
            $('#whatif-section').hide();
        });
        
        // Handle edit lineups button click
        $('#edit-lineups-btn').click(function() {
            prepareLineupsModal();
            $('#editLineupsModal').modal('show');
        });
        
        // Handle save lineups button click
        $('#save-lineups-btn').click(function() {
            applyLineupChanges();
            $('#editLineupsModal').modal('hide');
        });
        
        // Handle what-if analysis update button
        $('#update-simulation-btn').click(function() {
            updateSimulation();
        });
    });
    
    // Populate team dropdowns
    function populateTeamDropdowns() {
        let homeOptions = '<option value="">Select Home Team</option>';
        let awayOptions = '<option value="">Select Away Team</option>';
        
        nbaTeams.forEach(team => {
            homeOptions += `<option value="${team}">${team}</option>`;
            awayOptions += `<option value="${team}">${team}</option>`;
        });
        
        $('#home-team').html(homeOptions);
        $('#away-team').html(awayOptions);
    }
    
    // Update team lineups based on selected teams
    function updateTeamLineups() {
        // Update team names
        $('#home-team-name').text(selectedHomeTeam);
        $('#away-team-name').text(selectedAwayTeam);
        
        // Get lineups (in production, this would be an API call)
        // For MVP, use sample data for a few teams and generate random players for others
        let homeLineup = getTeamLineup(selectedHomeTeam);
        let awayLineup = getTeamLineup(selectedAwayTeam);
        
        // Update lineup display
        updateLineupDisplay('home', homeLineup);
        updateLineupDisplay('away', awayLineup);
    }
    
    // Get lineup for a team (sample data or generated)
    function getTeamLineup(teamName) {
        // Check if we have sample data for this team
        if (teamRosters[teamName]) {
            return teamRosters[teamName];
        }
        
        // Generate random lineup
        return [
            { name: `${teamName} PG`, position: "PG", rating: Math.floor(Math.random() * 15) + 75 },
            { name: `${teamName} SG`, position: "SG", rating: Math.floor(Math.random() * 15) + 75 },
            { name: `${teamName} SF`, position: "SF", rating: Math.floor(Math.random() * 15) + 75 },
            { name: `${teamName} PF`, position: "PF", rating: Math.floor(Math.random() * 15) + 75 },
            { name: `${teamName} C`, position: "C", rating: Math.floor(Math.random() * 15) + 75 },
            { name: `${teamName} 6th Man`, position: "SG", rating: Math.floor(Math.random() * 10) + 70 },
            { name: `${teamName} Bench 1`, position: "PF", rating: Math.floor(Math.random() * 10) + 70 },
            { name: `${teamName} Bench 2`, position: "PG", rating: Math.floor(Math.random() * 10) + 70 }
        ];
    }
    
    // Update lineup display
    function updateLineupDisplay(team, lineup) {
        let html = '';
        
        // Sort by position for display
        const sortedLineup = [...lineup].sort((a, b) => {
            const posOrder = { "PG": 1, "SG": 2, "SF": 3, "PF": 4, "C": 5 };
            return posOrder[a.position] - posOrder[b.position];
        });
        
        // Get starters (first 5 players)
        const starters = sortedLineup.slice(0, 5);
        
        // Display each player
        starters.forEach(player => {
            html += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-secondary me-2">${player.position}</span>
                        <span>${player.name}</span>
                    </div>
                    <span class="badge bg-primary rounded-pill">${player.rating}</span>
                </li>
            `;
        });
        
        // Update the lineup list
        $(`#${team}-lineup`).html(html);
    }
    
    // Prepare lineups modal for editing
    function prepareLineupsModal() {
        // Update team names in modal
        $('#edit-home-team-name').text(selectedHomeTeam);
        $('#edit-away-team-name').text(selectedAwayTeam);
        
        // Get current lineups
        const homeLineup = getTeamLineup(selectedHomeTeam);
        const awayLineup = getTeamLineup(selectedAwayTeam);
        
        // Update current player names
        const positions = ['PG', 'SG', 'SF', 'PF', 'C'];
        
        positions.forEach(pos => {
            // Find players for this position
            const homePlayer = homeLineup.find(p => p.position === pos);
            const awayPlayer = awayLineup.find(p => p.position === pos);
            
            // Update displayed current players
            $(`#home-${pos.toLowerCase()}`).text(homePlayer ? homePlayer.name : `No ${pos} in roster`);
            $(`#away-${pos.toLowerCase()}`).text(awayPlayer ? awayPlayer.name : `No ${pos} in roster`);
            
            // Populate replacement dropdowns
            populateReplacementDropdown('home', pos, homeLineup, homePlayer);
            populateReplacementDropdown('away', pos, awayLineup, awayPlayer);
        });
    }
    
    // Populate replacement dropdown for a position
    function populateReplacementDropdown(team, position, roster, currentPlayer) {
        const $select = $(`.${team}-player-select[data-position="${position}"]`);
        let options = '<option value="">Select Player</option>';
        
        // Get all players who can play this position
        const eligiblePlayers = roster.filter(player => 
            // Players who primarily play this position or similar positions
            // Simplified position groups for MVP
            (position === 'PG' && ['PG', 'SG'].includes(player.position)) ||
            (position === 'SG' && ['SG', 'PG', 'SF'].includes(player.position)) ||
            (position === 'SF' && ['SF', 'SG', 'PF'].includes(player.position)) ||
            (position === 'PF' && ['PF', 'SF', 'C'].includes(player.position)) ||
            (position === 'C' && ['C', 'PF'].includes(player.position))
        );
        
        // Add each eligible player to dropdown
        eligiblePlayers.forEach(player => {
            const isCurrentPlayer = currentPlayer && player.name === currentPlayer.name;
            // Don't include current player as an option
            if (!isCurrentPlayer) {
                options += `<option value="${player.name}" data-rating="${player.rating}">${player.name} (${player.position}, ${player.rating})</option>`;
            }
        });
        
        $select.html(options);
    }
    
    // Apply lineup changes from modal
    function applyLineupChanges() {
        // This would trigger an update to the lineups and then re-run the simulation
        // For MVP, just show a message
        alert('Lineup changes would be applied and simulation re-run in the full version.');
        
        // In production, this would update the actual lineups and re-run the simulation
    }
    
    // Simulate matchup between selected teams
    function simulateMatchup() {
        // Show loading state
        $('#simulate-btn').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Simulating...');
        $('#simulate-btn').prop('disabled', true);
        
        // In production, this would be an API call
        // For MVP, simulate a delay and then show mock results
        setTimeout(function() {
            generateSimulationResults();
            
            // Reset button state
            $('#simulate-btn').html('<i class="fas fa-chart-line me-2"></i> Simulate Matchup');
            $('#simulate-btn').prop('disabled', false);
            
            // Show results sections
            $('#results-section').show();
            $('#whatif-section').show();
            
            // Scroll to results
            $('html, body').animate({
                scrollTop: $('#results-section').offset().top - 100
            }, 500);
        }, 1500);
    }
    
    // Generate simulation results
    function generateSimulationResults() {
        // Update team names and logos
        $('#home-team-result').text(selectedHomeTeam);
        $('#away-team-result').text(selectedAwayTeam);
        
        // Update team logos
        $('#home-team-logo').attr('src', `/static/img/teams/${selectedHomeTeam.replace(/\s+/g, '').toLowerCase()}.png`);
        $('#away-team-logo').attr('src', `/static/img/teams/${selectedAwayTeam.replace(/\s+/g, '').toLowerCase()}.png`);
        
        // Generate random scores (would be based on actual simulation in production)
        const homeBaseScore = Math.floor(Math.random() * 20) + 100; // 100-120
        const awayBaseScore = Math.floor(Math.random() * 20) + 100; // 100-120
        
        // Apply home court advantage
        const homeCourtAdvantage = 3.5;
        const homeScore = homeBaseScore + homeCourtAdvantage;
        const awayScore = awayBaseScore;
        
        // Calculate win probability
        const totalPoints = homeScore + awayScore;
        const homeWinProbability = Math.min(Math.round((homeScore / totalPoints) * 100), 95);
        const awayWinProbability = 100 - homeWinProbability;
        
        // Update scores and probabilities
        $('#home-predicted-score').text(homeScore.toFixed(1));
        $('#away-predicted-score').text(awayScore.toFixed(1));
        $('#home-win-probability').text(homeWinProbability);
        $('#away-win-probability').text(awayWinProbability);
        
        // Winner gets a highlight
        if (homeScore > awayScore) {
            $('#home-team-result').addClass('text-success').removeClass('text-danger');
            $('#away-team-result').addClass('text-muted').removeClass('text-success text-danger');
        } else {
            $('#away-team-result').addClass('text-success').removeClass('text-danger');
            $('#home-team-result').addClass('text-muted').removeClass('text-success text-danger');
        }
        
        // Update key factors based on random values for MVP
        updateKeyFactors(homeScore > awayScore);
        
        // Generate player matchups
        generateKeyMatchups();
        
        // Create charts
        createTeamComparisonChart(homeScore, awayScore);
        createWinProbabilityChart(homeWinProbability, awayWinProbability);
    }
    
    // Update key factors
    function updateKeyFactors(homeWinning) {
        // In production, these would be calculated based on actual team statistics
        // For MVP, use random values with a bias toward the winning team
        
        // Recent form
        const recentFormFactor = (Math.random() * 4 + 1) * (homeWinning ? 1 : -1);
        $('#recent-form-badge')
            .text(recentFormFactor > 0 ? 
                  `+${recentFormFactor.toFixed(1)} points for Home` : 
                  `+${Math.abs(recentFormFactor).toFixed(1)} points for Away`)
            .removeClass('bg-success bg-danger')
            .addClass(recentFormFactor > 0 ? 'bg-success' : 'bg-danger');
        
        // Shooting
        const shootingFactor = (Math.random() * 3 + 0.5) * (Math.random() > 0.5 ? 1 : -1);
        $('#shooting-badge')
            .text(shootingFactor > 0 ? 
                  `+${shootingFactor.toFixed(1)} points for Home` : 
                  `+${Math.abs(shootingFactor).toFixed(1)} points for Away`)
            .removeClass('bg-success bg-danger')
            .addClass(shootingFactor > 0 ? 'bg-success' : 'bg-danger');
        
        // Matchup history
        const historyOptions = ['Neutral', `Favors ${selectedHomeTeam}`, `Favors ${selectedAwayTeam}`];
        const selectedOption = historyOptions[Math.floor(Math.random() * 3)];
        $('#history-badge')
            .text(selectedOption)
            .removeClass('bg-success bg-danger bg-secondary')
            .addClass(selectedOption === 'Neutral' ? 'bg-secondary' : 
                      selectedOption.includes(selectedHomeTeam) ? 'bg-success' : 'bg-danger');
    }
    
    // Generate key matchups table
    function generateKeyMatchups() {
        // Get rosters
        const homeRoster = getTeamLineup(selectedHomeTeam);
        const awayRoster = getTeamLineup(selectedAwayTeam);
        
        // Create matchups
        let matchupsHtml = '';
        const positions = ['PG', 'SG', 'SF', 'PF', 'C'];
        
        positions.forEach(pos => {
            // Find players for this position
            const homePlayer = homeRoster.find(p => p.position === pos);
            const awayPlayer = awayRoster.find(p => p.position === pos);
            
            if (homePlayer && awayPlayer) {
                // Determine advantage
                let advantageClass = '';
                let advantageIcon = '';
                
                if (homePlayer.rating > awayPlayer.rating + 2) {
                    advantageClass = 'text-success text-end';
                    advantageIcon = '<i class="fas fa-arrow-right"></i>';
                } else if (awayPlayer.rating > homePlayer.rating + 2) {
                    advantageClass = 'text-danger text-start';
                    advantageIcon = '<i class="fas fa-arrow-left"></i>';
                } else {
                    advantageClass = 'text-muted text-center';
                    advantageIcon = '<i class="fas fa-equals"></i>';
                }
                
                // Generate random stats for display
                const homePoints = (Math.random() * 10 + 10).toFixed(1);
                const homeRebounds = (Math.random() * 5 + 2).toFixed(1);
                const homeAssists = (Math.random() * 4 + 1).toFixed(1);
                
                const awayPoints = (Math.random() * 10 + 10).toFixed(1);
                const awayRebounds = (Math.random() * 5 + 2).toFixed(1);
                const awayAssists = (Math.random() * 4 + 1).toFixed(1);
                
                // Add to table
                matchupsHtml += `
                    <tr>
                        <td>${pos}</td>
                        <td>${awayPlayer.name}</td>
                        <td>${awayPoints} pts, ${awayRebounds} reb, ${awayAssists} ast</td>
                        <td class="${advantageClass}">${advantageIcon}</td>
                        <td>${homePoints} pts, ${homeRebounds} reb, ${homeAssists} ast</td>
                        <td>${homePlayer.name}</td>
                    </tr>
                `;
            }
        });
        
        // Update table
        $('#matchups-table').html(matchupsHtml);
    }
    
    // Create team comparison chart
    function createTeamComparisonChart(homeScore, awayScore) {
        const ctx = document.getElementById('teamComparisonChart').getContext('2d');
        
        // Generate random stats for metrics
        const homeOffensiveRating = homeScore + Math.random() * 10;
        const homeDefensiveRating = 110 - Math.random() * 10;
        const homePace = 98 + Math.random() * 6;
        const homeTsPct = 55 + Math.random() * 10;
        
        const awayOffensiveRating = awayScore + Math.random() * 10;
        const awayDefensiveRating = 110 - Math.random() * 10;
        const awayPace = 98 + Math.random() * 6;
        const awayTsPct = 55 + Math.random() * 10;
        
        // Destroy existing chart if it exists
        if (teamComparisonChart) {
            teamComparisonChart.destroy();
        }
        
        // Create the chart
        teamComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Offensive Rating', 'Defensive Rating', 'Pace', 'True Shooting %'],
                datasets: [
                    {
                        label: selectedHomeTeam,
                        data: [homeOffensiveRating, homeDefensiveRating, homePace, homeTsPct],
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    },
                    {
                        label: selectedAwayTeam,
                        data: [awayOffensiveRating, awayDefensiveRating, awayPace, awayTsPct],
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Team Performance Metrics'
                    }
                }
            }
        });
    }
    
    // Create win probability chart
    function createWinProbabilityChart(homeWinProbability, awayWinProbability) {
        const ctx = document.getElementById('winProbabilityChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (winProbabilityChart) {
            winProbabilityChart.destroy();
        }
        
        // Create the chart
        winProbabilityChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [selectedHomeTeam, selectedAwayTeam],
                datasets: [{
                    data: [homeWinProbability, awayWinProbability],
                    backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)'],
                    borderColor: ['rgb(54, 162, 235)', 'rgb(255, 99, 132)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Win Probability'
                    }
                }
            }
        });
    }
    
    // Update simulation based on what-if sliders
    function updateSimulation() {
        // Get slider values
        const homePerformance = parseInt($('#home-performance-slider').val());
        const awayPerformance = parseInt($('#away-performance-slider').val());
        const homeCourtAdvantage = parseInt($('#home-court-slider').val());
        
        // Calculate updated scores
        const homeBaseScore = parseFloat($('#home-predicted-score').text()) - 3; // Remove default home court advantage
        const awayBaseScore = parseFloat($('#away-predicted-score').text());
        
        // Apply adjustments
        const adjustedHomeScore = homeBaseScore + (homePerformance / 10) + homeCourtAdvantage;
        const adjustedAwayScore = awayBaseScore + (awayPerformance / 10);
        
        // Calculate win probability
        const totalPoints = adjustedHomeScore + adjustedAwayScore;
        const homeWinProbability = Math.min(Math.round((adjustedHomeScore / totalPoints) * 100), 95);
        const awayWinProbability = 100 - homeWinProbability;
        
        // Update scores and probabilities
        $('#home-predicted-score').text(adjustedHomeScore.toFixed(1));
        $('#away-predicted-score').text(adjustedAwayScore.toFixed(1));
        $('#home-win-probability').text(homeWinProbability);
        $('#away-win-probability').text(awayWinProbability);
        
        // Winner gets a highlight
        if (adjustedHomeScore > adjustedAwayScore) {
            $('#home-team-result').addClass('text-success').removeClass('text-muted text-danger');
            $('#away-team-result').addClass('text-muted').removeClass('text-success text-danger');
        } else {
            $('#away-team-result').addClass('text-success').removeClass('text-muted text-danger');
            $('#home-team-result').addClass('text-muted').removeClass('text-success text-danger');
        }
        
        // Update charts
        createTeamComparisonChart(adjustedHomeScore, adjustedAwayScore);
        createWinProbabilityChart(homeWinProbability, awayWinProbability);
    }
</script>
{% endblock %}